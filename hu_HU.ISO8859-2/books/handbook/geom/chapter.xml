<?xml version="1.0" encoding="iso-8859-2"?>
<!--
     The FreeBSD Documentation Project
     $FreeBSD$
-->
<!-- The FreeBSD Hungarian Documentation Project
     Translated by: PALI, Gabor <pgj@FreeBSD.org>
     %SOURCE%	en_US.ISO8859-1/books/handbook/geom/chapter.xml
     %SRCID%	1.50
-->
<chapter xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="GEOM" xml:lang="hu">
  <info><title>GEOM: A moduláris lemezszervezõ rendszer</title>
    <authorgroup>
      <author><personname><firstname>Tom</firstname><surname>Rhodes</surname></personname><contrib>Írta: </contrib></author>
    </authorgroup>
  </info>

  

  <sect1 xml:id="GEOM-synopsis">
    <title>Áttekintés</title>

    <indexterm><primary>GEOM</primary></indexterm>
    <indexterm>
      <primary>A GEOM lemezrendszer</primary>
      <see>GEOM</see>
    </indexterm>

    <para>Ez a fejezet a &os;-ben található GEOM rendszert
      mutatja be.  Ez a rendszer tömöríti az
      általa is alkalmazott fontosabb <acronym role="Redundant       Array of Inexpensive Disks (Olcsó lemezek       hibatûrõ       tömbje)">RAID</acronym>-vezérlõ
      segédprogramokat.  A fejezet nem részletezi, hogy a
      GEOM konkrétan milyen módon kezeli és
      vezérli az I/O-t, ahogy azt sem, hogyan mûködik
      az alapjául szolgáló alrendszer vagy hogy
      néz ki annak forráskódja.  Az ilyen
      jellegû információk a &man.geom.4; man oldalon,
      valamint az ott felsorolt helyeken találhatóak meg.
      Továbbá, ez a fejezet magukról a
      <acronym>RAID</acronym>-konfigurációkról sem
      ad pontos tájékoztatást.
      Kizárólag csak a GEOM által is
      támogatott
      <acronym>RAID</acronym>-besorolásokról esik
      szó.</para>

    <para>A fejezet elolvasása során
      megismerjük:</para>

    <itemizedlist>
      <listitem>
	<para>a GEOM segítségével milyen
	  fajtájú <acronym>RAID</acronym>
	  támogatást érhetünk el;</para>
      </listitem>

      <listitem>
	<para>hogyan kell használni a rendszer által
	  nyújtott alapvetõ segédeszközöket
	  a különféle <acronym>RAID</acronym>-szintek
	  konfigurálásához,
	  karbantartásához és
	  kezeléséhez;</para>
      </listitem>

      <listitem>
	<para>hogyan kell a GEOM-on keresztül tükrözni,
	  csíkozni, titkosítani és
	  távolról összekapcsolni lemezes
	  eszközöket;</para>
      </listitem>

      <listitem>
	<para>hogyan kell a GEOM rendszerben összekapcsolt
	  lemezeknél felmerülõ hibákat
	  felderíteni.</para>
      </listitem>
    </itemizedlist>

	<para>A fejezet elolvasásához
	  ajánlott:</para>

    <itemizedlist>
      <listitem>
	<para>megérteni, hogyan kezeli a &os; a lemezes
	  eszközöket (<xref linkend="disks"/>);</para>
      </listitem>

      <listitem>
	<para>ismerni, hogyan konfiguráljunk és
	  telepítsünk egy új &os; rendszermagot (<xref linkend="kernelconfig"/>).</para>
      </listitem>
    </itemizedlist>
  </sect1>

  <sect1 xml:id="GEOM-intro">
    <title>A GEOM bemutatása</title>

    <para>A GEOM rendszer adatszolgáltatókon vagy
      speciális <filename>/dev</filename>-állományokon
      keresztül hozzáférést és
      vezérlést tesz lehetõvé bizonyos
      osztályokhoz &mdash; Master Boot Recordokhoz,
      <acronym>BSD</acronym>-címkékhez stb.  Számos
      szoftveres <acronym>RAID</acronym> konfiguráció
      támogatásával a GEOM transzparens
      elérést tesz lehetõvé mind az
      operációs rendszer, mind pedig az általa
      felkínált segédprogramok
      számára.</para>

  </sect1>

  <sect1 xml:id="GEOM-striping">
    <info><title>RAID0 - Csíkozás</title>
      <authorgroup>
	<author><personname><firstname>Tom</firstname><surname>Rhodes</surname></personname><contrib>Írta: </contrib></author>
	<author><personname><firstname>Murray</firstname><surname>Stokely</surname></personname></author>
      </authorgroup>
    </info>

    

    <indexterm><primary>GEOM</primary></indexterm>
    <indexterm><primary>Lemezcsíkozás</primary></indexterm>

    <para>A csíkozás módszerét
      használjuk abban az esetben, amikor több
      lemezmeghajtót akarunk egyetlen kötetté
      összevonni.  A GEOM lemezalrendszer szoftveres
      támogatást nyújt a <acronym>RAID</acronym>0,
      más néven a lemezcsíkozás
      megvalósításához.</para>

    <para>Egy <acronym>RAID</acronym>0 rendszerben az adatokat blokkokra
      bontva írjuk fel a tömbben található
      lemezek között szétosztva.  Így ahelyett,
      hogy meg kellene várnunk 256 kb-nyi adat egyetlen lemezre
      írását, egy <acronym>RAID</acronym>0
      rendszerben egyszerre íródik 64 kb-nyi adat
      négy különbözõ lemezre, és
      ezáltal gyorsabb elérést szolgáltat.
      Ez a gyorsaság további lemezvezérlõk
      használatával még jobban
      fokozható.</para>

    <para>Az egy <acronym>RAID</acronym>0-csíkozásban
      résztvevõ lemezek mindegyikének azonos
      méretûnek kell lennie, mivel az írásra
      és olvasásra irányuló
      I/O-kérések a párhuzamos
      kiszolgálás érdekében
      összefésülõdnek.</para>

    <mediaobject>
      <imageobject>
	<imagedata fileref="geom/striping" align="center"/>
      </imageobject>

      <textobject>
	<phrase>Példa lemezcsíkozásra</phrase>
      </textobject>
    </mediaobject>

    <procedure>
      <title>Csíkozás kialakítása
	formázatlan ATA-lemezekkel</title>

      <step>
	<para>Töltsük be a <filename>geom_stripe.ko</filename>
	  modult:</para>

	<screen>&prompt.root; <userinput>kldload geom_stripe</userinput></screen>
      </step>

      <step>
	<para>Bizonyosodjuk meg róla, hogy a rendszerünkben
	  található egy szabad csatlakozási pont.
	  Ha majd ezt a kötetet szánjuk rendszerünk
	  gyökérpartíciójának,
	  használjunk erre a célra egy másik
	  könyvtárat, például a <filename>/mnt</filename>-ot:</para>

	<screen>&prompt.root; <userinput>mkdir /mnt</userinput></screen>
      </step>

      <step>
	<para>Keressük meg a csíkozásra
	  felhasználni kívánt lemezek
	  eszközneveit, és hozzunk létre
	  belõlük egy új csíkozott eszközt.
	  Például, ha két használatban nem
	  levõ, particionálatlan
	  <acronym>ATA</acronym>-lemezt, név szerint a
	  <filename>/dev/ad2</filename> és
	  <filename>/dev/ad3</filename> eszközöket akarjunk
	  csíkozni:</para>

	<screen>&prompt.root; <userinput>gstripe label -v st0 /dev/ad2 /dev/ad3</userinput>
Metadata value stored on /dev/ad2.
Metadata value stored on /dev/ad3.
Done.</screen>
      </step>

      <step>
	<para>Az így létrejött új köteten
	  most hozzunk létre egy általános
	  címkét, vagy más néven egy
	  partíciós táblát, és
	  telepítsük fel rá a rendszer
	  alapértelmezett rendszerindító
	  programját:</para>

	<screen>&prompt.root; <userinput>bsdlabel -wB /dev/stripe/st0</userinput></screen>
      </step>

      <step>
	<para>Ezzel meg kellett jelennie további másik
	  két eszköznek is a <filename>/dev/stripe</filename>
	  könyvtárban, a <filename>st0</filename>
	  eszköz mellett.  Ezek többek közt az
	  <filename>st0a</filename> és az
	  <filename>st0c</filename>.  Itt már ki is tudunk
	  alakítani egy állományrendszert az
	  <filename>st0a</filename> eszközön a
	  <command>newfs</command> használatával:</para>

	<screen>&prompt.root; <userinput>newfs -U /dev/stripe/st0a</userinput></screen>

	<para>Sok-sok számot fogunk látni cikázni a
	  képernyõn, majd néhány
	  másodperc múlva befejezõdik a folyamat.
	  Létrehoztuk a kötetet, ami most már
	  készen áll a becsatolásra.</para>
      </step>
    </procedure>

    <para>A kialakított lemezcsíkozást így
      tudjuk kézzel csatlakoztatni:</para>

    <screen>&prompt.root; <userinput>mount /dev/stripe/st0a /mnt</userinput></screen>

    <para>A csíkozott állományrendszert a
      rendszerindítás folyamán automatikusan
      becsatlakoztathatjuk, ha elhelyezzük az alábbi
      kötetinformációkat az
      <filename>/etc/fstab</filename> állományba.  Erre a
      célra <filename>stripe</filename>
      néven létrehozunk egy állandó
      csatlakozási pontot:</para>

    <screen>&prompt.root; <userinput>mkdir /stripe</userinput>
&prompt.root; <userinput>echo "/dev/stripe/st0a /stripe ufs rw 2 2" \</userinput>
      <userinput>&gt;&gt; /etc/fstab</userinput></screen>

    <para>A <filename>geom_stripe.ko</filename> modult is automatikusan
      be kell tölteni a rendszerindítás során.
      Ehhez a következõ sort kell hozzáadni a
      <filename>/boot/loader.conf</filename>
      állományhoz:</para>

    <screen>&prompt.root; <userinput>echo 'geom_stripe_load="YES"' &gt;&gt; /boot/loader.conf</userinput></screen>

  </sect1>

  <sect1 xml:id="GEOM-mirror">
    <title>RAID1 - Tükrözés</title>

    <indexterm><primary>GEOM</primary></indexterm>
    <indexterm><primary>lemeztükrözés</primary></indexterm>

    <para>A tükrözés számos
      vállalatnál és háztartásban
      alkalmazott technológia, amely az adatok
      megszakítás nélküli
      lementésére használatos.  Amikor
      tükrözést használunk, az egyszerûen
      csak arra utal, hogy a B lemez ugyanazokat az adatokat
      tartalmazza, mint az A lemez.  Vagy amikor a C és D lemez
      tartalma egyezik meg az A és B lemezekével.
      Függetlenül a lemezek kiosztásától,
      itt az a lényeg, hogy az egyik lemez teljes területe
      vagy az egyik partíciója le van másolva.
      Késõbb az ezen a módon lementett adatok
      könnyen visszaállíthatóak
      anélkül, hogy ez a szolgáltatásban vagy
      az elérhetõségben bármilyen
      kimaradást okozna, és akár még
      fizikailag is biztonságosan tárolhatóak.</para>

    <para>Elõször is szereznünk kell két egyforma
      méretû lemezt, valamint a példák
      feltételezik, hogy ezek a lemezek közvetlen
      elérésû (&man.da.4;)
      <acronym>SCSI</acronym>-lemezek.</para>

    <sect2>
      <title>Az elsõdleges lemezek
	tükrözése</title>

      <para>Tegyük fel, hogy a &os; az elsõ,
	<filename>da0</filename> nevû lemezmeghajtón
	található, és a &man.gmirror.8;
	számára ezt szeretnénk megadni az
	elsõdleges adatok tárolásához.</para>

      <para>A tükrözés
	létrehozásának megkezdése elõtt a
	<varname>kern.geom.debugflags</varname> &man.sysctl.8;
	változó megfelelõ
	beállításával
	engedélyezzünk további
	nyomkövetési információkat és
	hozzáférést az eszközhöz:</para>

      <screen>&prompt.root; <userinput>sysctl kern.geom.debugflags=17</userinput></screen>

      <para>Most építsük fel a
	tükrözést.  Kezdjük az egészet a
	metaadatok elhelyezésével az elsõdleges
	lemezmeghajtón, tehát tulajdonképpen az
	alábbi parancs segítségével hozzuk
	létre a <filename>/dev/mirror/gm</filename>
	eszközt:</para>

      <warning>
	<para>A rendszerindító meghajtóról
	  készített tükrözés
	  adatvesztést okozhat a lemez utolsó
	  szektorában.  Ennek kockázata
	  csökkenthetõ, ha közvetlenül a &os; friss
	  telepítése után állítjuk be
	  a tükrözést.</para>
      </warning>

      <screen>&prompt.root; <userinput>gmirror label -vb round-robin gm0 /dev/da0</userinput></screen>

      <para>Erre a rendszernek a következõ módon kell
	reagálnia:</para>

      <screen>Metadata value stored on /dev/da0.
Done.</screen>

      <para>A GEOM inicializálásához
	szükségünk lesz a
	<filename>/boot/kernel/geom_mirror.ko</filename> modul
	betöltésére:</para>

      <screen>&prompt.root; <userinput>gmirror load</userinput></screen>

      <note>
	<para>A parancs sikeres lefutása után a <filename>/dev/mirror</filename>
	  könyvtárban létrehoz egy
	  <filename>gm0</filename>
	  eszközleírót.</para>
      </note>

      <para>A <filename>geom_mirror.ko</filename> modul
	betöltését így tudjuk
	engedélyezni a rendszer indításakor:</para>

      <screen>&prompt.root; <userinput>echo 'geom_mirror_load="YES"' &gt;&gt; /boot/loader.conf</userinput></screen>

      <para>Nyissuk meg az <filename>/etc/fstab</filename>
	állományt, és cseréljük le
	benne az összes korábbi <filename>da0</filename>
	hivatkozást az újonnan kialakított
	<filename>gm0</filename> tükrözés
	eszközleírójával.</para>

      <note>
	<para>Ha &man.vi.1; szövegszerkesztõt
	  használjuk, akkor a következõ módon
	  tudjuk ezt egyszerûen megtenni:</para>

	<screen>&prompt.root; <userinput>vi /etc/fstab</userinput></screen>

	<para>A &man.vi.1; indítása után a
	  <userinput>:w /etc/fstab.bak</userinput>
	  kiadásával készítsünk az
	  <filename>fstab</filename> állomány jelenlegi
	  tartalmáról másolatot.  Ezután a
	  <userinput>:%s/da/mirror\/gm/g</userinput> parancs
	  használatával cseréljük ki az
	  összes <filename>da0</filename> hivatkozást a
	  <filename>gm0</filename> eszköz nevére.</para>
      </note>

      <para>Az így keletkezõ <filename>fstab</filename>
	állomány nagyjából következõ
	módon fog kinézni.  Most teljesen független,
	hogy <acronym>SCSI</acronym> vagy <acronym>ATA</acronym>
	meghajtókkal dolgozunk, a <acronym>RAID</acronym>
	eszköz neve mindig <filename>gm</filename> lesz:</para>

      <programlisting># Eszköz                Csatlakozási pont   Típus   Beállítások  Dump   Menet
/dev/mirror/gm0s1b      none                swap    sw           0      0
/dev/mirror/gm0s1a      /                   ufs     rw           1      1
/dev/mirror/gm0s1d      /usr                ufs     rw           0      0
/dev/mirror/gm0s1f      /home               ufs     rw           2      2
#/dev/mirror/gm0s2d     /store              ufs     rw           2      2
/dev/mirror/gm0s1e      /var                ufs     rw           2      2
/dev/acd0               /cdrom              cd9660  ro,noauto    0      0</programlisting>

      <para>Indítsuk újra a rendszert:</para>

      <screen>&prompt.root; <userinput>shutdown -r now</userinput></screen>

      <para>Ennek megfelelõen a rendszer indítása
	közben a <filename>da0</filename> eszköz helyett a
	<filename>gm0</filename> eszközt fogjuk
	használni.  Miután sikeresen
	befejezõdött a rendszerindítás, a
	<command>mount</command> parancs kiadásával a
	saját szemünkkel is meggyõzõdhetünk
	az eredményrõl:</para>

      <screen>&prompt.root; <userinput>mount</userinput>
Filesystem         1K-blocks    Used    Avail Capacity  Mounted on
/dev/mirror/gm0s1a   1012974  224604   707334    24%    /
devfs                      1       1        0   100%    /dev
/dev/mirror/gm0s1f  45970182   28596 42263972     0%    /home
/dev/mirror/gm0s1d   6090094 1348356  4254532    24%    /usr
/dev/mirror/gm0s1e   3045006 2241420   559986    80%    /var
devfs                      1       1        0   100%    /var/named/dev</screen>

      <para>A parancs kimenete az elvárásainknak
	megfelelõen remekül néz ki.
	Zárásképpen a szinkronizálás
	megkezdéséhez a következõ paranccsal
	illesszük be a <filename>da1</filename> eszközt a
	tükrözésbe:</para>

      <screen>&prompt.root; <userinput>gmirror insert gm0 /dev/da1</userinput></screen>

      <para>A tükrözés állapota a
	létrejöttét követõen az alábbi
	paranccsal ellenõrizhetõ:</para>

      <screen>&prompt.root; <userinput>gmirror status</userinput></screen>

      <para>Az iménti parancs eredményének
	nagyjából a következõnek kell lennie
	miután a felépítettük a
	tükrözést és szinkronizáltuk az
	adatokat:</para>

      <screen>      Name    Status  Components
mirror/gm0  COMPLETE  da0
                      da1</screen>

      <para>Hiba esetén a tükrözés
	továbbra is folytatódik, azonban ilyenkor a
	példában szereplõ <literal>COMPLETE</literal>
	helyett a <literal>DEGRADED</literal> jelzést fogjuk
	látni.</para>
    </sect2>

    <sect2>
      <title>Hibakeresés</title>

      <sect3>
	<title>A rendszer nem hajlandó elindulni</title>

	<para>Ha a rendszerünk ehhez hasonló módon
	  indul:</para>

	<programlisting>ffs_mountroot: can't find rootvp
Root mount failed: 6
mountroot&gt;</programlisting>

	<para>Indítsuk újra a gépünket a
	  kikapcsoló gomb vagy a reset
	  segítségével.  A
	  rendszerindító menüben válasszuk a
	  hatodik opciót (6).  Ennek
	  eredményeképpen megkapjuk a &man.loader.8;
	  parancssorát.  Töltsük be a modult
	  manuálisan:</para>

	<screen>OK? <userinput>load geom_mirror</userinput>
OK? <userinput>boot</userinput></screen>

	<para>Ha ez beválik, akkor valamiért a modult nem
	  sikerült rendesen betölteni.
	  Ellenõrizzük, hogy a
	  <filename>/boot/loader.conf</filename>
	  állományban a neki szereplõ megfelelõ
	  bejegyzés helyesen szerepel.  Amennyiben a
	  probléma továbbra is fennáll,
	  helyezzük el a következõ sort a rendszermag
	  konfigurációs állományába,
	  majd fordítsuk újra és
	  telepítsük:</para>

	<programlisting>options	GEOM_MIRROR</programlisting>

	<para>Ezzel várhatóan orvosoltuk a
	  problémát.</para>
      </sect3>
    </sect2>

    <sect2>
      <title>A meghibásodott lemezek cseréje</title>

      <para>A lemezek tükrözésének egyik
	legcsodálatosabb elõnye, hogy a menet közben
	meghibásodott meghajtókat gond, és
	így feltehetõen adatvesztés
	nélkül ki tudjuk cserélni.</para>

      <para>Vegyük az iménti <acronym>RAID</acronym>-1
	konfigurációt, és tételezzük fel,
	hogy a <filename>da1</filename> eszköz felmondta a
	szolgáltatot és cserére szorul.  A
	meghajtó leváltásához keressük
	meg a hibás eszközt, majd állítsuk le
	a rendszert.  Tegyük be a helyére az újat
	és indítsuk újra a rendszerünket.
	Miután elindult az operációs rendszer, a
	következõ parancsok kiadásával tudjuk
	logikailag is lecserélni a meghibásodott
	lemezt:</para>

      <screen>&prompt.root; <userinput>gmirror forget gm0</userinput>
&prompt.root; <userinput>gmirror insert gm0 /dev/da1</userinput></screen>

      <para>Innen a <command>gmirror</command> <option>status</option>
	parancsával kísérhetjük figyelemmel a
	tükrözés újraszervezésének
	menetét.  Csupán ennyi az egész.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="geom-ggate">
    <title>Eszközök hálózati illesztése a
      GEOM-ban</title>

    <para>A GEOM távoli eszközök, például
      lemezek, CD-meghajtók stb.  használatát is
      támogatja a hálózati illesztést
      szolgáló segédprogramjaival, hasonlóan
      az <acronym>NFS</acronym>-hez.</para>

    <para>Kezdésként létre kell hozni a
      megosztást elõsegítõ
      állományt.  Ez az állomány
      határozza meg, ki és milyen szinten jogosult
      használni a megosztott erõforrásokat.
      Például ha megosztjuk az elsõ
      <acronym>SCSI</acronym>-lemezen a negyedik slice-ot, az
      alábbi <filename>/etc/gg.exports</filename>
      állomány tökéletesen megfelel:</para>

    <programlisting>192.168.1.0/24 RW /dev/da0s4d</programlisting>

    <para>Ezzel a belsõ hálózaton levõ
      összes számítógép képes
      lesz elérni a <filename>da0s4d</filename>
      partíción található
      állományrendszert.</para>

    <para>Az eszköz megosztásához elõször
      gondoskodnunk kell róla, hogy ne legyen csatlakoztatva,
      majd ezután indítsuk el a &man.ggated.8; szerver
      démonját:</para>

    <screen>&prompt.root; <userinput>ggated</userinput></screen>

    <para>Ezt követõen a <command>mount</command>
      felhasználásával csatoljuk az eszközt a
      kliensen, az alábbi parancs
      kiadásával:</para>

    <screen>&prompt.root; <userinput>ggatec create -o rw 192.168.1.1 /dev/da0s4d</userinput>
ggate0
&prompt.root; <userinput>mount /dev/ggate0 /mnt</userinput></screen>

    <para>Innentõl kezdve az eszköz elérhetõ lesz
      a <filename>/mnt</filename> csatlakozási
      ponton keresztül.</para>

    <note>
      <para>Fontos kiemelnünk, hogy ez a mûvelet
	eredménytelen, ha az adott eszközt vagy maga a
	szerver, vagy pedig valamelyik másik kliens már
	korábban csatolta.</para>
    </note>

    <para>Amikor az eszközre már nincs tovább
      szükségünk, biztonságosan le tudjuk
      választani az &man.umount.8; paranccsal, hasonlóan
      bármelyik más lemezes eszközhöz.</para>

  </sect1>

  <sect1 xml:id="geom-glabel">
    <title>A lemezes eszközök
      címkézése</title>

    <indexterm><primary>GEOM</primary></indexterm>
    <indexterm><primary>Lemezcímkék</primary></indexterm>

    <para>A rendszer indítása közben a &os;
      rendszermagja a talált eszközöknek
      megfelelõen mindegyiknek létrehoz egy-egy
      eszközleírót.  Ezzel a
      próbálgatásos módszerrel együtt
      jár néhány gond, például mi
      történik akkor, ha az új lemezes eszközt
      <acronym>USB</acronym>-n keresztül adjuk a rendszerhez?
      Nagyon valószínû, hogy ez az eszköz
      megkapja a <filename>da0</filename> nevet és ezzel az
      eredeti <filename>da0</filename> eszköz eltolódik
      a <filename>da1</filename> névhez.  Ennek
      köszönhetõen az <filename>/etc/fstab</filename>
      állományban felsorolt
      állományrendszerek csatolása veszélybe
      kerül, aminek következtében akár
      meghiúsulhat a rendszerindulás is.</para>

    <para>Az egyik lehetséges megoldása a
      problémának, ha sorbafûzzük a
      <acronym>SCSI</acronym> eszközeinket, és így a
      <acronym>SCSI</acronym>-kártyához kapcsolt
      újabb eszköz egy addig nem használt
      számot fog birtokba venni.  Mi helyzet azonban az
      <acronym>USB</acronym>-s eszközökkel, amelyek
      kiüthetik az elsõdleges
      <acronym>SCSI</acronym>-lemezeinket?  Ez egyébként
      azért történhet meg, mert az
      <acronym>USB</acronym>-s eszközöket
      általában hamarabb keresi a rendszer, mint a
      <acronym>SCSI</acronym> kártyán levõ
      eszközöket.  Megoldhatjuk úgy ezt a gondot, hogy
      csak azután csatlakoztatjuk az említett
      eszközöket, miután a rendszer elindult.
      Megoldhatjuk viszont úgy is, hogy csak egyetlen
      <acronym>ATA</acronym>-meghajtót használunk
      és soha nem soroljuk fel a <acronym>SCSI</acronym>
      eszközöket az <filename>/etc/fstab</filename>
      állományban.</para>

    <para>Ezeknél kínálkozik azonban egy jobb
      megoldás!  A <command>glabel</command> nevû
      segédprogrammal a rendszergazda vagy a
      felhasználó úgy tudja címkézni
      a lemezmeghajtókat, hogy azok a
      <filename>/etc/fstab</filename> állományban
      szereplõ címkéket használják.
      Mivel a <command>glabel</command> a címkét az adott
      szolgáltató utolsó szektorában
      tárolja el, ez a címke megmarad az
      újraindítás után is.  Ha ezt a
      címkét eszközként használjuk, az
      állományrendszerek mindig ugyanarról a
      meghajtóról fognak csatolódni,
      függetlenül attól, hogy milyen
      eszközleírón keresztül érjük
      el ezeket.</para>

    <note>
      <para>Egyáltalán nem állítottuk, hogy
	egy címke csak állandó lehet.  A
	<command>glabel</command> segítségével
	egyaránt létre lehet hozni állandó
	és átmeneti címkéket, de csak az
	állandó címke képes az
	újraindítás után is megmaradni.  A
	két címketípus közti
	különbségeket a &man.glabel.8; man oldal
	tárgyalja részletesebben.</para>
    </note>

    <sect2>
      <title>Címketípusok és
	példák</title>

      <para>A címkéknek két típusa
	létezik, az általános címke
	és az állományrendszer-címke.  A
	címkék lehetnek állandóak vagy
	ideiglenesek.  Az állandó címkék a
	&man.tunefs.8; vagy &man.newfs.8; parancsokkal hozhatóak
	létre.  Ezek a címkék az adott
	állományrendszer típusa alapján
	elnevezett alkönyvtárakban jönnek létre
	a <filename>/dev</filename>
	könyvtáron belül.  Például az
	<acronym>UFS</acronym>2
	állományrendszer-címkék a <filename>/dev/ufs</filename> könyvtárban
	keletkeznek.  Állandó címkék a
	<command>glabel label</command> paranccsal hozhatóak
	létre.  Az ilyen címkék nem függenek
	az állományrendszerek
	típusától, a <filename>/dev/label</filename> könyvtárban
	jönnek létre.</para>

      <para>Az ideiglenes címkék a következõ
	induláskor elvesznek.  Ezek a címkék a
	<filename>/dev/label</filename>
	könyvtárban keletkeznek, és ideálisak
	a kísérletezgetésre.  Ideiglenes
	címkéket a <command>glabel create</command>
	paranccsal hozhatunk létre.  Ezzel kapcsolatosan
	részletesebb felvilágosítást a
	&man.glabel.8; man oldalon találhatunk.</para>

      <para>Ha egy <acronym>UFS</acronym>2
	állományrendszerre szeretnénk tenni egy
	állandó címkét az adataink
	megsemmisítése nélkül, adjuk ki a
	következõ parancsot:</para>

      <screen>&prompt.root; <userinput>tunefs -L home /dev/da3</userinput></screen>

      <warning>
	<para>Ha az érintett állományrendszeren
	  nincs üres hely, ennek a parancsnak a használata
	  adatvesztéshez vezethet.  Ilyen esetben inkább a
	  felesleges állományok
	  eltávolításával kellene
	  törõdnünk, nem pedig címkék
	  hozzáadásával.</para>
      </warning>

      <para>Ezután egy címkének kell megjelennie a
	<filename>/dev/ufs</filename>
	könyvtárban, amelyet vegyünk is fel az
	<filename>/etc/fstab</filename> állományba:</para>

      <programlisting>/dev/ufs/home		/home            ufs     rw              2      2</programlisting>

      <note>
	<para>Az állományrendszert tilos csatolni a
	  <command>tunefs</command> futtatása alatt!</para>
      </note>

      <para>Most már a megszokott módon csatolhatjuk az
	állományrendszert:</para>

      <screen>&prompt.root; <userinput>mount /home</userinput></screen>

      <para>Ettõl a ponttól kezdve, amíg a
	<filename>geom_label.ko</filename> modul betöltõdik a
	rendszerindítás során a
	<filename>/boot/loader.conf</filename> állományon
	keresztül, vagy a <literal>GEOM_LABEL</literal>
	opció megtalálható a rendszermag
	konfigurációs állományában,
	az eszközleíró a rendszerre nézve
	minden komolyabb következmény nélkül
	megváltozhat.</para>

      <para>Állományrendszereket létrehozhatunk
	alapértelmezett címkével is a
	<command>newfs</command> <option>-L</option>
	paraméterével.  Errõl részletesebben a
	&man.newfs.8; man oldalon olvashatunk.</para>

      <para>Az alábbi paranccsal tudjuk törölni a
	címkét:</para>

      <screen>&prompt.root; <userinput>glabel destroy home</userinput></screen>

      <para>A következõ példában azt
	láthatjuk, hogyan címkézzük fel a
	rendszerindító lemezünk
	partícióit.</para>

      <example>
	<title>Partíciók címkézése a
	  rendszerindító lemezen</title>

	<para>A rendszerindításra használt lemezen
	  levõ partíciók
	  felcímkézésével a rendszer
	  képes lesz akkor is minden probléma
	  nélkül elindulni, amikor áthelyezzük
	  egy másik vezérlõre vagy átrakjuk
	  egy másik számítógépbe.
	  Például most tegyük fel, hogy van egy
	  <acronym>ATA</acronym> csatolós lemezünk, amelyet
	  a rendszer <filename>ad0</filename> néven ismert
	  fel.  Továbbá azt is feltételezzük,
	  hogy a &os; telepítése esetén megszokott
	  partícionálási sémát
	  választottuk, ahol <filename>/</filename>, <filename>/var</filename>, <filename>/usr</filename> és <filename>/tmp</filename>
	  állományrendszereink, valamint egy
	  lapozóterületünk van.</para>

	<para>Indítsuk újra a rendszerünket és
	  a &man.loader.8; menüjében a <keycap>4</keycap>
	  billentyû lenyomásával válasszuk az
	  egyfelhasználós módot.  Ezt
	  követõen adjuk ki a következõ
	  parancsokat:</para>

	<screen>&prompt.root; <userinput>glabel label rootfs /dev/ad0s1a</userinput>
GEOM_LABEL: Label for provider /dev/ad0s1a is label/rootfs
&prompt.root; <userinput>glabel label var /dev/ad0s1d</userinput>
GEOM_LABEL: Label for provider /dev/ad0s1d is label/var
&prompt.root; <userinput>glabel label usr /dev/ad0s1f</userinput>
GEOM_LABEL: Label for provider /dev/ad0s1f is label/usr
&prompt.root; <userinput>glabel label tmp /dev/ad0s1e</userinput>
GEOM_LABEL: Label for provider /dev/ad0s1e is label/tmp
&prompt.root; <userinput>glabel label swap /dev/ad0s1b</userinput>
GEOM_LABEL: Label for provider /dev/ad0s1b is label/swap
&prompt.root; <userinput>exit</userinput></screen>

	<para>A rendszer indítása ezután
	  többfelhasználós módban
	  folytatódik.  A rendszerindítás
	  befejezõdése után nyissuk meg az
	  <filename>/etc/fstab</filename> állományt
	  és írjuk át a hagyományos
	  eszközneveket a hozzájuk tartozó
	  címkékre.  Az <filename>/etc/fstab</filename>
	  végleges változata ennek megfelelõen
	  körülbelül így fog
	  kinézni:</para>

	<programlisting># Eszköz                 Csatlakozási pont  Típus   Beállítások     Dump    Menet
/dev/label/swap          none               swap    sw              0        0
/dev/label/rootfs        /                  ufs     rw              1        1
/dev/label/tmp           /tmp               ufs     rw              2        2
/dev/label/usr           /usr               ufs     rw              2        2
/dev/label/var           /var               ufs     rw              2        2</programlisting>

	<para>A rendszer most már
	  újraindítható.  Ha mindent jól
	  csináltunk, akkor a rendszer indítása
	  problémáktól mentesen fog zajlani
	  és a <command>mount</command> parancs eredménye
	  a következõ lesz:</para>

	<screen>&prompt.root; <userinput>mount</userinput>
/dev/label/rootfs on / (ufs, local)
devfs on /dev (devfs, local)
/dev/label/tmp on /tmp (ufs, local, soft-updates)
/dev/label/usr on /usr (ufs, local, soft-updates)
/dev/label/var on /var (ufs, local, soft-updates)</screen>
      </example>

      <para>A &os;&nbsp;7.2 kiadásától
	kezdõdõen a &man.glabel.8; osztály az
	<acronym>UFS</acronym> esetén támogatja az
	<literal>ufsid</literal>, az állományrendszer
	egyedi rendszerszintû
	azonosítójából származtatott
	új címketípus használatát.
	Ezek a címkék a rendszer indítása
	során a <filename>/dev/ufsid</filename>
	könyvtárban jönnek automatikusan létre.
	Az <literal>ufsid</literal> címkéken
	keresztül tudunk az <filename>/etc/fstab</filename>
	állományban állományrendszereket
	csatlakoztatni.  A jelenleg aktív
	állományrendszereket és azok
	<literal>ufsid</literal> azonosítóit a
	<command>glabel status</command> paranccsal tudjuk
	lekérdezni:</para>

      <screen>&prompt.user; <userinput>glabel status</userinput>
                  Name  Status  Components
ufsid/486b6fc38d330916     N/A  ad4s1d
ufsid/486b6fc16926168e     N/A  ad4s1f</screen>

      <para>Ebben a példában az
	<filename>ad4s1d</filename> képviseli a <filename>/var</filename>
	állományrendszert, míg a
	<filename>ad4s1f</filename> a <filename>/usr</filename>
	állományrendszert.  Az adott
	<literal>ufsid</literal> értékek
	megadásával az <filename>/etc/fstab</filename>
	állományban a következõképpen
	tudjuk csatlakoztatni ezeket az
	állományrendszereket:</para>

      <programlisting>/dev/ufsid/486b6fc38d330916        /var        ufs        rw        2      2
/dev/ufsid/486b6fc16926168e        /usr        ufs        rw        2      2</programlisting>

      <para>Minden <literal>ufsid</literal> címkével
	rendelkezõ partíció csatlakoztatható
	ezen a módon.  Ekkor nem kell manuálisan
	létrehoznunk a számunkra állandó
	címkéket, így automatikusan
	élvethezhetjük az eszköznévtõl
	független csatlakoztatás elõnyeit.</para>
    </sect2>
  </sect1>

  <sect1 xml:id="geom-gjournal">
    <title>Naplózó UFS GEOM-on keresztül</title>

    <indexterm><primary>GEOM</primary></indexterm>
    <indexterm><primary>naplózás</primary></indexterm>

    <para>A &os;&nbsp;7.0-ás verziójának
      megjelenésével egy rég várt
      kiegészítés, a naplózás
      vált végre elérhetõvé
      vált.  Maga az implementáció a
      <acronym>GEOM</acronym> alrendszeren keresztül
      érhetõ el, és a &man.gjournal.8;
      segédprogram segítségével
      könnyedén beállítható.</para>

    <para>Mit is jelent a naplózás?  A
      naplózás támogatásával a
      rendszer egy naplót vezet az
      állományrendszert érintõ
      tranzakciókról &mdash; például az
      olyan változtatásokról, amelyek egy komplett
      írási mûveletet eredményeznek &mdash;
      mielõtt még a metaadatok és
      lemezírási mûveletek szabályosan
      befejezõdnének.  Ez a könyvelés
      késõbb visszajátszható az
      állományrendszerben lezajlott tranzakciók
      reprodukálásához, és ezzel
      megelõzhetõek az állományrendszerben
      keletkezõ esetleges ellentmondások.</para>

    <para>Ez egy újabb módszer az adatvesztés
      és az állományrendszerben
      elõforduló ellentmondások
      elkerülésére.  Eltérõen a Soft
      Updates módszertõl, ahol a metaadatok
      frissítését biztosítják
      és követik nyomon, vagy a Snapshots
      módszertõl, ahol pillanatképeket
      tárolunk az állományrendszerrõl, itt egy
      konkrét naplót tárolunk a lemez erre a
      célra fenntartott részén, amely bizonyos
      esetekben akár egy teljes külön merevlemez is
      lehet.</para>

    <para>Ellentétben a többi naplózó
      állományrendszertõl, a
      <command>gjournal</command> módszere blokk alapú
      és nem az állományrendszer
      részeként került implementálásra
      &mdash; csupán a <acronym>GEOM</acronym> egyik
      bõvítménye.</para>

    <para>A <command>gjournal</command>
      támogatásához a &os; rendszermag
      konfigurációs állományában be
      kell állítani a következõ opciót
      &mdash; amely a 7.0 és késõbbi rendszereken
      alapbeállítás:</para>

    <programlisting>options	UFS_GJOURNAL</programlisting>

    <para>Amennyiben naplózással rendelkezõ
      köteteket szeretnénk a rendszerindítás
      során csatlakoztatni, a
      <filename>/boot/loader.conf</filename> állományban
      következõ sor hozzáadásával
      töltessük be a <filename>geom_journal.ko</filename>
      modult:</para>

    <programlisting>geom_journal_load="YES"</programlisting>

    <para>Szükség esetén ezt a funkciót
      akár a rendszermagba is beépíthetjük, ha
      felvesszük a következõ sort a rendszermag
      konfigurációs
      állományába:</para>

    <programlisting>options	GEOM_JOURNAL</programlisting>

    <para>Ha ezt aktiváltuk, egy szabad
      állományrendszeren az alábbi
      lépéseken keresztül tudunk létrehozni
      egy naplót, feltéve, hogy a
      <filename>da4</filename> egy új
      <acronym>SCSI</acronym>-meghajtó:</para>

    <screen>&prompt.root; <userinput>gjournal load</userinput>
&prompt.root; <userinput>gjournal label /dev/ad4</userinput></screen>

    <para>Ennél a pontnál lennie kell egy
      <filename>/dev/da4</filename> és egy
      <filename>/dev/da4.journal</filename>
      eszközleírónak.  Hozzunk létre egy
      állományrendszert ezen az eszközön:</para>

    <screen>&prompt.root; <userinput>newfs -O 2 -J /dev/da4.journal</userinput></screen>

    <para>Ez a parancs létrehoz egy <acronym>UFS</acronym>2
      állományrendszert a naplóval rendelkezõ
      eszközön.</para>

    <para>Csatoljuk is be a <command>mount</command>
      segítségével az eszközt
      kívánt csatlakozási pontra:</para>

    <screen>&prompt.root; <userinput>mount /dev/da4.journal /mnt</userinput></screen>

    <note>
      <para>Ha több slice-unk is van, akkor a napló
	mindegyik slice-hoz külön létrejön.
	Például, ha az <filename>ad4s1</filename>
	és <filename>ad4s2</filename> egyaránt
	slice-ok, akkor a <command>gjournal</command> legyártja
	az <filename>ad4s1.journal</filename> és
	<filename>ad4s2.journal</filename>
	eszközleírókat.</para>
    </note>

    <para>A jobb teljesítmény elérése
      érdekében kívánatos lehet a
      naplót egy másik lemezen tartani.  Ilyen esetekben a
      naplózás bekapcsolásához a
      naplót biztosító szolgáltatót
      vagy tárolóeszközt a naplózni
      kívánt eszköz után kell szerepeltetni.
      A naplózás akár az aktuálisan
      használt állományrendszeren is
      aktiválható a <command>tunefs</command>
      használatával.  Az állományrendszer
      módosításakor viszont mindig érdemes
      biztonsági másolatot készíteni!  Az
      esetek többségében a
      <command>gjournal</command> hibát fog jelezni, mivel nem
      tudja létrehozni a naplót, azonban ez nem
      védi meg az adatainkat a <command>tunefs</command>
      helytelen használata által okozott
      sérülésektõl.</para>

    <para>A rendszerindító lemezen is lehet
      naplózást használni.  Ennek részleit a
      <link xlink:href="&url.articles.gjournal-desktop;">Naplózó UFS használata asztali számítógépeken</link>
      címû cikkbõl ismerhetjük meg.</para>
  </sect1>
</chapter>
